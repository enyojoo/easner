"use strict";exports.id=380,exports.ids=[380],exports.modules={23380:(e,t,r)=>{r.d(t,{yE:()=>c,Ov:()=>l,W4:()=>o});var a=r(85662);class s{set(e,t,r=this.DEFAULT_TTL){this.cache.set(e,{data:t,timestamp:Date.now(),ttl:r,isStale:!1})}get(e){let t=this.cache.get(e);if(!t)return null;let r=Date.now()-t.timestamp;return r>this.STALE_WHILE_REVALIDATE_TTL?(this.cache.delete(e),null):(r>t.ttl&&(t.isStale=!0),t.data)}isStale(e){let t=this.cache.get(e);return!t||Date.now()-t.timestamp>t.ttl}getWithRefresh(e,t){let r=this.get(e);return r&&this.isStale(e)&&!this.refreshPromises.has(e)&&this.refreshPromises.set(e,t().then(t=>(this.set(e,t),t)).catch(t=>(console.error(`Background refresh failed for ${e}:`,t),r)).finally(()=>{this.refreshPromises.delete(e)})),r}invalidate(e){this.cache.delete(e),this.refreshPromises.delete(e)}invalidatePattern(e){let t=new RegExp(e);for(let e of this.cache.keys())t.test(e)&&(this.cache.delete(e),this.refreshPromises.delete(e))}clear(){this.cache.clear(),this.refreshPromises.clear()}async forceRefresh(e,t){this.invalidate(e);let r=await t();return this.set(e,r),r}getStats(){return{size:this.cache.size,refreshing:this.refreshPromises.size,keys:Array.from(this.cache.keys())}}constructor(){this.cache=new Map,this.DEFAULT_TTL=12e4,this.STALE_WHILE_REVALIDATE_TTL=3e5,this.refreshPromises=new Map}}let i=new s,n={CURRENCIES:"currencies",EXCHANGE_RATES:"exchange_rates",USER_TRANSACTIONS:e=>`user_transactions_${e}`,TRANSACTION:e=>`transaction_${e}`,USER_PROFILE:e=>`user_profile_${e}`},o={async findByEmail(e){let{data:t,error:r}=await a.OQ.from("users").select("*").eq("email",e).single();if(r&&"PGRST116"!==r.code)throw r;return t},async updateProfile(e,t){let{data:r,error:s}=await a.OQ.from("users").update({first_name:t.firstName,last_name:t.lastName,phone:t.phone,base_currency:t.baseCurrency,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(s)throw s;return i.invalidate(n.USER_PROFILE(e)),r},async getStats(){let{data:e}=await a.OQ.from("users").select("id",{count:"exact"}),{data:t}=await a.OQ.from("users").select("id",{count:"exact"}).eq("status","active"),{data:r}=await a.OQ.from("users").select("id",{count:"exact"}).eq("verification_status","verified");return{total:e?.length||0,active:t?.length||0,verified:r?.length||0}}},c={async getAll(){let e=async()=>{let{data:e,error:t}=await a.OQ.from("currencies").select("id, code, name, symbol, flag_svg, status, created_at, updated_at").eq("status","active").order("code");if(t)throw t;return e?.map(e=>({...e,flag:e.flag_svg}))||[]},t=i.getWithRefresh(n.CURRENCIES,e);if(t)return t;let r=await e();return i.set(n.CURRENCIES,r,3e5),r},async getExchangeRates(){let e=async()=>{let{data:e,error:t}=await a.OQ.from("exchange_rates").select(`
          *,
          from_currency_info:currencies!exchange_rates_from_currency_fkey(id, code, name, symbol, flag_svg),
          to_currency_info:currencies!exchange_rates_to_currency_fkey(id, code, name, symbol, flag_svg)
        `).eq("status","active");if(t)throw t;return e?.map(e=>({...e,from_currency_info:e.from_currency_info?{...e.from_currency_info,flag:e.from_currency_info.flag_svg}:void 0,to_currency_info:e.to_currency_info?{...e.to_currency_info,flag:e.to_currency_info.flag_svg}:void 0}))||[]},t=i.getWithRefresh(n.EXCHANGE_RATES,e);if(t)return t;let r=await e();return i.set(n.EXCHANGE_RATES,r,12e4),r},async getRate(e,t){let{data:r,error:s}=await a.OQ.from("exchange_rates").select("*").eq("from_currency",e).eq("to_currency",t).eq("status","active").single();if(s&&"PGRST116"!==s.code)throw s;return r},async updateRate(e,t,r,s="free",o=0){let{data:c,error:l}=await a.OQ.from("exchange_rates").upsert({from_currency:e,to_currency:t,rate:r,fee_type:s,fee_amount:o,status:"active",updated_at:new Date().toISOString()}).select().single();if(l)throw l;return i.invalidate(n.EXCHANGE_RATES),c}},l={async create(e){let t=`NP${Date.now()}`;try{let r=new Promise((e,t)=>setTimeout(()=>t(Error("Transaction creation timeout")),15e3)),s=a.OQ.from("transactions").insert({transaction_id:t,user_id:e.userId,recipient_id:e.recipientId,send_amount:e.sendAmount,send_currency:e.sendCurrency,receive_amount:e.receiveAmount,receive_currency:e.receiveCurrency,exchange_rate:e.exchangeRate,fee_amount:e.feeAmount,fee_type:e.feeType,total_amount:e.totalAmount,reference:e.reference}).select().single(),{data:o,error:c}=await Promise.race([s,r]);if(c)throw c;return i.invalidate(n.USER_TRANSACTIONS(e.userId)),o}catch(e){throw console.error("Transaction creation error:",e),Error("Failed to create transaction. Please check your connection and try again.")}},async getByUserId(e,t=20){let r=async()=>{let{data:r,error:s}=await a.OQ.from("transactions").select(`
          *,
          recipient:recipients(*)
        `).eq("user_id",e).order("created_at",{ascending:!1}).limit(t);if(s)throw s;return r||[]},s=i.getWithRefresh(n.USER_TRANSACTIONS(e),r);if(s)return s;let o=await r();return i.set(n.USER_TRANSACTIONS(e),o,6e4),o},async getById(e){let t=async()=>{let{data:t,error:r}=await a.OQ.from("transactions").select(`
          *,
          recipient:recipients(*),
          user:users(first_name, last_name, email)
        `).eq("transaction_id",e).single();if(r)throw r;return t},r=i.getWithRefresh(n.TRANSACTION(e),t);if(r)return r;let s=await t(),o="completed"===s.status?3e5:3e4;return i.set(n.TRANSACTION(e),s,o),s},async updateStatus(e,t){let r={status:t};"completed"===t&&(r.completed_at=new Date().toISOString());let{data:s,error:o}=await a.OQ.from("transactions").update(r).eq("transaction_id",e).select().single();if(o)throw o;return i.invalidate(n.TRANSACTION(e)),i.invalidatePattern("user_transactions_"),s},async uploadReceipt(e,t){try{let r=new Promise((e,t)=>setTimeout(()=>t(Error("Transaction check timeout")),1e4)),s=a.OQ.from("transactions").select("id, transaction_id").eq("transaction_id",e).single(),{data:o,error:c}=await Promise.race([s,r]);if(c||!o)throw console.error("Transaction check error:",c),Error("Transaction not found. Please create the transaction first.");let l=t.name.split(".").pop(),u=`${e}.${l}`,f=`receipts/${u}`,h=new Promise((e,t)=>setTimeout(()=>t(Error("Upload timeout")),3e4)),d=a.OQ.storage.from("transaction-receipts").upload(f,t,{cacheControl:"3600",upsert:!1}),{data:_,error:m}=await Promise.race([d,h]);if(m)throw console.error("Upload error:",m),Error(`Upload failed: ${m.message}`);let{data:{publicUrl:g}}=a.OQ.storage.from("transaction-receipts").getPublicUrl(f),p=new Promise((e,t)=>setTimeout(()=>t(Error("Database update timeout")),1e4)),E=a.OQ.from("transactions").update({receipt_url:g,receipt_filename:u,updated_at:new Date().toISOString()}).eq("transaction_id",e).select(),{data:y,error:S}=await Promise.race([E,p]);if(S)throw console.error("Database update error:",S),Error(`Database update failed: ${S.message}`);if(!y||0===y.length)throw Error("Failed to update transaction with receipt");let w=y[0];return i.invalidate(n.TRANSACTION(e)),{...w,receipt_url:g}}catch(e){throw console.error("Receipt upload error:",e),e}},async getStats(e="today"){let t=new Date;switch(e){case"today":t.setHours(0,0,0,0);break;case"week":t.setDate(t.getDate()-7);break;case"month":t.setMonth(t.getMonth()-1)}let{data:r}=await a.OQ.from("transactions").select("*").gte("created_at",t.toISOString()),{data:s}=await a.OQ.from("transactions").select("id",{count:"exact"}).in("status",["pending","processing"]),i=r?.reduce((e,t)=>e+Number(t.send_amount),0)||0;return{totalTransactions:r?.length||0,totalVolume:i,pendingTransactions:s?.length||0}}}},85662:(e,t,r)=>{r.d(t,{OQ:()=>n,lx:()=>o});var a=r(69498);let s=process.env.NEXT_PUBLIC_SUPABASE_URL||"https://placeholder.supabase.co",i=process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY||"placeholder-key",n=(0,a.eI)(s,i,{auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0,flowType:"pkce"}}),o=()=>{let e=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e){if(!process.env.VERCEL)throw Error("Missing SUPABASE_SERVICE_ROLE_KEY environment variable");return(0,a.eI)(s,i,{auth:{persistSession:!1,autoRefreshToken:!1}})}return(0,a.eI)(s,e,{auth:{persistSession:!1,autoRefreshToken:!1}})}}};